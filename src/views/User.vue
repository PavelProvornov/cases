<template>
    <div class="user-cabinet">
      <h1 class="content-title">Профиль игрока</h1>
      <div class="user-cabinet__statistics cabinet-statistics">
        <div class="cabinet-statistics__col user-stat">
          <div class="user-stat__userinfo">
            <div class="user-stat__avatar">
              <div class="user-stat__avatar-wrapper">
                <img src="@/assets/avatar.jpg" alt="" class="user-stat__avatar-item">
              </div>
            </div>
            <div class="user-stat__data">
              <p class="user-stat__username">{{user.username}}</p>
              <i class="user-stat__related-source-ico"></i>
            </div>
          </div>
          <div class="user-stat__total">
            <div class="user-stat__total-item">
              <p class="total-item__amount">836</p>
              <p class="total-item__title">Кейсов открыто</p>
            </div>
            <div class="user-stat__total-item">
              <p class="total-item__amount">85 000,00$</p>
              <p class="total-item__title">Сумма предметов</p>
            </div>
            <div class="user-stat__total-item">
              <p class="total-item__amount">3879</p>
              <p class="total-item__title">Предметов выведенно</p>
            </div>
          </div>
        </div>
        <div class="cabinet-statistics__col top-drop">
          <h3 class="top-drop__title">3 Самых дрогих скина</h3>
          <div class="top-drop__row">
            <div class="top-drop__item rare-basic">
              <span class="top-drop__item--arrow"></span>
              <img src="@/assets/gunExample.png" alt="" class="top-drop__image">
              <h4 class="top-drop__item-title">Какой-то автомат</h4>
              <div class="top-drop__item-price">500₽</div>
              <i class="top-drop__item-icon"></i>
              <span class="top-drop__item-ft">ft</span>
            </div>
            <div class="top-drop__item rare-yellow">
              <span class="top-drop__item--arrow"></span>
              <img src="@/assets/gunExample.png" alt="" class="top-drop__image">
              <h4 class="top-drop__item-title">Какой-то автомат длинноеслово</h4>
              <div class="top-drop__item-price">750₽</div>
              <i class="top-drop__item-icon"></i>
              <span class="top-drop__item-ft">ft</span>
            </div>
            <div class="top-drop__item rare-purple">
              <span class="top-drop__item--arrow"></span>
              <img src="@/assets/gunExample.png" alt="" class="top-drop__image">
              <h4 class="top-drop__item-title">Какой-то автомат</h4>
              <div class="top-drop__item-price">907₽</div>
              <i class="top-drop__item-icon"></i>
              <span class="top-drop__item-ft">ft</span>
            </div>
          </div>
        </div>
      </div>
      <h2 class="content-title">Выпашие предметы</h2>
      <div class="user-cabinet__drop user-drop">

        <div class="user-drop__item drop-item" v-for="(index, i) of items" :key="i">
          <div class="drop-item__inner">
            <img :src="item.box.image" alt="" class="drop-item__image">
              <h4 class="drop-item__title">{{ item.item.name_first }} {{item.item.name_second}}</h4>
              <div class="drop-item__price">750₽</div>
              <i class="drop-item__icon"></i>
              <span class="drop-item__ft">ft</span>
            <span class="deco"></span>
          </div>
        </div>
      </div>
    </div>
</template>

<script>
    import axios from 'axios';
    import $ from 'jquery'

    export default {
        data() {
            return {
                user: [],
                activeTab: 'items',
                type: '',
                trade_link: '',
                items: [],
                contracts: [],
                page: 0,
                morePage: false,
                loadingMore: false
            }
        },
        methods: {
            async get() {
                const request = await axios.post('/api/users/get', {id: this.$route.params.id});

                if (request.data.success) {
                    this.type = request.data.type;
                    this.user = request.data.user;
                    this.trade_link = this.user.trade_link;

                    this.loadItems();

                    this.$root.hideLoading();
                } else {
                    this.$router.go(-1);
                }
            },
            async saveLink() {
                const request = await axios.post('/api/users/saveLink', {trade_link: this.trade_link});
                const data = request.data;

                $.wnoty({
                    type: data.type,
                    message: this.$t(`users.${data.message}`)
                });
            },
            async loadItems() {
                this.loadingMore = true;
                const request = await axios.post('/api/users/items', {id: this.$route.params.id, page: this.page += 1});

                const array = this.items;
                Array.prototype.push.apply(array, request.data.items);

                this.items = array;
                this.morePage = request.data.more;
                this.loadingMore = false;
            },
            async loadContracts() {
                this.loadingMore = true;
            },
            async sellItem(id, i) {
                const request = await axios.post('/api/users/sell', {id: id});
                const data = request.data;

                this.$root.getBalance();

                if (data.type === 'success') {
                    if (this.$i18n.locale === 'ru') {
                        if (this.user.allPrice[0].myBet !== null) this.user.allPrice[0].myBet = parseInt(this.user.allPrice[0].myBet) - parseInt(this.items[i].item.price);
                    } else {
                        if (this.user.allPrice[0].myBet_en !== null) this.user.allPrice[0].myBet_en = parseFloat(this.user.allPrice[0].myBet_en) - parseFloat(this.items[i].item.price_en);
                    }
                    this.items[i].status = 1;
                    this.$forceUpdate();
                }

                $.wnoty({
                    type: data.type,
                    message: this.$t(`users.${data.message}`)
                });
            },
            async buyItem(id, i) {
                $.wnoty({
                    type: 'info',
                    message: this.$t('users.waitRequest')
                });

                const request = await axios.post('/api/users/buy', {id: id});
                const data = request.data;

                if (data.type === 'success') {
                    this.items[i].status = data.status;
                    this.$forceUpdate();
                }

                $.wnoty({
                    type: data.type,
                    message: this.$t(`users.${data.message}`)
                });
            },
            async loadTab(tab) {
                switch (tab) {
                    case 'items':
                        this.loadItems();
                        this.activeTab = 'items';
                        break;
                    case 'contracts':
                        this.loadContracts();
                        this.activeTab = 'contracts';
                        break;
                }
            },
            async sellAll() {
                $.wnoty({
                    type: 'info',
                    message: this.$t('users.selling')
                });

                const request = await axios.post('/api/users/sellAll');
                const data = request.data;

                if (data.type === 'success') {
                    for (let i in this.items) {
                        this.items[i].status = 1;
                    }
                    this.$root.getBalance();
                    this.user.allPrice[0].myBet = 0;
                    this.$forceUpdate();
                }

                $.wnoty({
                    type: data.type,
                    message: this.$t(`users.${data.message}`)
                });
            }
        },
        mounted() {
            this.$root.showLoading();
            this.get();
        },
        sockets: {
            setItemStatus: function (drop) {
                if (this.$root.user !== null && parseInt(drop.user_id) === parseInt(this.$root.user.id)) {
                    for (let [key, value] in this.items) {
                        if (this.items[key].id === drop.id) {
                            this.items[key].status = drop.status;
                            if (drop.status === 5) this.items[key].trade_id = drop.trade_id;
                            if (drop.status === 6) this.items[key].hover = 'item--hover';
                            this.$forceUpdate();
                        }
                        void value
                    }
                }
            }
        }
    }
</script>